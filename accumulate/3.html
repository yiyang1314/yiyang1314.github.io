<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>工业相机图像处理 | 易陽羽博客平台</title>
    <meta name="description" content="易陽羽博客平台">
    <link rel="icon" href="/images/test.jpg">
  <link rel="manifest" href="/images/test.jpg">
  <link rel="apple-touch-icon" href="/images/test.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.c9120bc4.css" as="style"><link rel="preload" href="/assets/js/app.4da30dd0.js" as="script"><link rel="preload" href="/assets/js/5.11d7f905.js" as="script"><link rel="prefetch" href="/assets/js/10.cfc7b205.js"><link rel="prefetch" href="/assets/js/11.cb8ae4bc.js"><link rel="prefetch" href="/assets/js/12.ab3ecb05.js"><link rel="prefetch" href="/assets/js/13.86f17a9a.js"><link rel="prefetch" href="/assets/js/14.ded0f1b1.js"><link rel="prefetch" href="/assets/js/15.86569fc0.js"><link rel="prefetch" href="/assets/js/16.38bf9bf2.js"><link rel="prefetch" href="/assets/js/2.33d9b4c1.js"><link rel="prefetch" href="/assets/js/3.b0ae39a2.js"><link rel="prefetch" href="/assets/js/4.a57a78a9.js"><link rel="prefetch" href="/assets/js/6.adf1cbb1.js"><link rel="prefetch" href="/assets/js/7.1581cf2f.js"><link rel="prefetch" href="/assets/js/8.3ca4c508.js"><link rel="prefetch" href="/assets/js/9.93f8b21b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9120bc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">易陽羽博客平台</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link router-link-active">JAVA知识</a></div><div class="nav-item"><a href="/others/" class="nav-link">前端开发</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">Dotnet软件开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">机器视觉开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">上位机开发</a></div><div class="nav-item"><a href="https://www.cnblogs.com/yiyangyu/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  易陽羽
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link router-link-active">JAVA知识</a></div><div class="nav-item"><a href="/others/" class="nav-link">前端开发</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">Dotnet软件开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">机器视觉开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">上位机开发</a></div><div class="nav-item"><a href="https://www.cnblogs.com/yiyangyu/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  易陽羽
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>工业相机图像处理</span> <!----></p> <ul class="sidebar-group-items"></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="工业相机图像处理"><a href="#工业相机图像处理" class="header-anchor">#</a> 工业相机图像处理</h1> <h3 id="_1-c-实现图像深度转换，并且保存常见的图像格式"><a href="#_1-c-实现图像深度转换，并且保存常见的图像格式" class="header-anchor">#</a> 1.C++实现图像深度转换，并且保存常见的图像格式</h3> <blockquote><p>用C++开发一份24位的RGB彩色图像buffer转化为8位图像,并且保存图像文件为tiff，bmp,png,raw格式，水平垂直分辨率为96；</p></blockquote> <p>以下是C++代码实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;iostream&gt;
#include &lt;fstream&gt;
#include &lt;vector&gt;
#include &lt;cmath&gt;
#include &lt;tiffio.h&gt;
#include &lt;png.h&gt;
#include &lt;opencv2/opencv.hpp&gt;

using namespace std;

void saveTIFF(string filename, vector&lt;unsigned char&gt;&amp; data, int width, int height)
{
    TIFF* tiff = TIFFOpen(filename.c_str(), &quot;w&quot;);

    TIFFSetField(tiff, TIFFTAG_IMAGEWIDTH, width);
    TIFFSetField(tiff, TIFFTAG_IMAGELENGTH, height);
    TIFFSetField(tiff, TIFFTAG_BITSPERSAMPLE, 8);
    TIFFSetField(tiff, TIFFTAG_COMPRESSION, COMPRESSION_NONE);
    TIFFSetField(tiff, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_RGB);
    TIFFSetField(tiff, TIFFTAG_SAMPLESPERPIXEL, 3);
    TIFFSetField(tiff, TIFFTAG_ROWSPERSTRIP, height);
    TIFFSetField(tiff, TIFFTAG_XRESOLUTION, 96.0);
    TIFFSetField(tiff, TIFFTAG_YRESOLUTION, 96.0);
    TIFFSetField(tiff, TIFFTAG_RESOLUTIONUNIT, RESUNIT_INCH);

    for (int row = 0; row &lt; height; ++row) {
        unsigned char* row_data = &amp;data[3 * width * row];
        if (TIFFWriteScanline(tiff, row_data, row, 0) &lt; 0) {
            cerr &lt;&lt; &quot;Error writing TIFF file: &quot; &lt;&lt; filename &lt;&lt; endl;
            break;
        }
    }

    TIFFClose(tiff);
}

void saveBMP(string filename, vector&lt;unsigned char&gt;&amp; data, int width, int height)
{
    cv::Mat image(height, width, CV_8UC3, &amp;data[0]);

    cv::imwrite(filename, image);
}

void savePNG(string filename, vector&lt;unsigned char&gt;&amp; data, int width, int height)
{
    FILE* file = fopen(filename.c_str(), &quot;wb&quot;);

    png_structp png_ptr = png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
    if (!png_ptr) {
        cerr &lt;&lt; &quot;Error creating PNG write struct&quot; &lt;&lt; endl;
        return;
    }

    png_infop info_ptr = png_create_info_struct(png_ptr);
    if (!info_ptr) {
        png_destroy_write_struct(&amp;png_ptr, (png_infopp)NULL);
        cerr &lt;&lt; &quot;Error creating PNG info struct&quot; &lt;&lt; endl;
        return;
    }

    png_init_io(png_ptr, file);

    png_set_IHDR(png_ptr, info_ptr, width, height, 8, PNG_COLOR_TYPE_RGB, PNG_INTERLACE_NONE, PNG_COMPRESSION_TYPE_BASE, PNG_FILTER_TYPE_BASE);
    png_set_pHYs(png_ptr, info_ptr, 96 * PNG_RESOLUTION_METER, 96 * PNG_RESOLUTION_METER, PNG_RESOLUTION_METER_UNIT_TYPE);

    png_write_info(png_ptr, info_ptr);

    vector&lt;png_bytep&gt; rows(height);
    for (int row = 0; row &lt; height; ++row) {
        rows[row] = &amp;data[3 * width * row];
    }

    png_write_image(png_ptr, &amp;rows[0]);

    png_write_end(png_ptr, NULL);

    png_destroy_write_struct(&amp;png_ptr, &amp;info_ptr);

    fclose(file);
}

void saveRAW(string filename, vector&lt;unsigned char&gt;&amp; data, int width, int height)
{
    ofstream file(filename.c_str(), ios::out | ios::binary);
    file.write((char*)&amp;data[0], data.size());
    file.close();
}


void convertTo8Bit(vector&lt;unsigned char&gt;&amp; rgb_data, vector&lt;unsigned char&gt;&amp; output_data, int width, int height)
{
    output_data.resize(width * height);

    for (int i = 0; i &lt; width * height; ++i) {
        int r = rgb_data[3 * i];
        int g = rgb_data[3 * i + 1];
        int b = rgb_data[3 * i + 2];

        int gray = int(0.299 * r + 0.587 * g + 0.114 * b + 0.5);

        output_data[i] = (gray &gt; 255) ? 255 : gray;
    }
}

int main()
{
    string input_filename = &quot;test.rgb&quot;;
    string output_filename_prefix = &quot;test&quot;;

    ifstream file(input_filename.c_str(), ios::in | ios::binary);

    int width = 640;
    int height = 480;

    vector&lt;unsigned char&gt; rgb_data(width * height * 3);
    vector&lt;unsigned char&gt; output_data;

    file.read((char*)&amp;rgb_data[0], rgb_data.size());

    convertTo8Bit(rgb_data, output_data, width, height);

    saveTIFF(output_filename_prefix + &quot;.tif&quot;, rgb_data, width, height);
    saveBMP(output_filename_prefix + &quot;.bmp&quot;, rgb_data, width, height);
    savePNG(output_filename_prefix + &quot;.png&quot;, rgb_data, width, height);
    saveRAW(output_filename_prefix + &quot;.raw&quot;, rgb_data, width, height);

    cout &lt;&lt; &quot;Images saved successfully&quot; &lt;&lt; endl;

    return 0;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br></div></div><p>上述代码包含了4个函数，分别用于保存tiff、bmp、png和raw格式的图像文件。其中，tiff和png文件需要使用相关库进行编译，具体为libtiff和libpng。另外，代码中使用了OpenCV库，用于将RGB数据转换成Mat格式，然后保存成bmp文件。</p> <p>主函数中，先读取24位RGB彩色图像数据，然后调用<code>convertTo8Bit</code>函数将其转换成8位灰度图像数据。最后分别调用保存函数将图像数据保存成不同格式的文件。其中，水平垂直分辨率都为96。</p> <p>需要注意的是，上述代码中只是做了简单的灰度值计算，如果需要更加精确的转换可以考虑使用其他的算法，如Luma通道计算。</p> <h3 id="_2-c-实现图像深度转换，并且保存常见的图像格式"><a href="#_2-c-实现图像深度转换，并且保存常见的图像格式" class="header-anchor">#</a> 2.C#实现图像深度转换，并且保存常见的图像格式</h3> <blockquote><p>C#开发一份24位的RGB彩色图像buffer转化为8位图像，并且保存图像文件为tiff，bmp,png,raw格式，水平垂直分辨率为480；</p></blockquote> <p>以下是C#代码实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>csharpCopy Codeusing System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;

namespace ImageConverter
{
    class Program
    {
        static void Main(string[] args)
        {
            string inputFilename = &quot;test.rgb&quot;;
            string outputFilenamePrefix = &quot;test&quot;;

            int width = 640;
            int height = 480;

            byte[] rgbData = File.ReadAllBytes(inputFilename);
            byte[] outputData;

            ConvertTo8Bit(rgbData, out outputData, width, height);

            SaveTIFF(outputFilenamePrefix + &quot;.tif&quot;, outputData, width, height);
            SaveBMP(outputFilenamePrefix + &quot;.bmp&quot;, outputData, width, height);
            SavePNG(outputFilenamePrefix + &quot;.png&quot;, outputData, width, height);
            SaveRAW(outputFilenamePrefix + &quot;.raw&quot;, outputData);

            Console.WriteLine(&quot;Images saved successfully&quot;);
        }

        static void ConvertTo8Bit(byte[] rgbData, out byte[] outputData, int width, int height)
        {
            outputData = new byte[width * height];

            for (int i = 0; i &lt; width * height; ++i)
            {
                int r = rgbData[3 * i];
                int g = rgbData[3 * i + 1];
                int b = rgbData[3 * i + 2];

                int gray = (int)(0.299 * r + 0.587 * g + 0.114 * b + 0.5);

                outputData[i] = (byte)(gray &gt; 255 ? 255 : gray);
            }
        }

        static void SaveTIFF(string filename, byte[] data, int width, int height)
        {
            using (var bitmap = new Bitmap(width, height, PixelFormat.Format8bppIndexed))
            {
                ColorPalette grayscalePalette = bitmap.Palette;
                for (int i = 0; i &lt; 256; ++i)
                {
                    grayscalePalette.Entries[i] = Color.FromArgb(i, i, i);
                }
                bitmap.Palette = grayscalePalette;

                Rectangle rect = new Rectangle(0, 0, width, height);
                BitmapData bitmapData = bitmap.LockBits(rect, ImageLockMode.WriteOnly, PixelFormat.Format8bppIndexed);

                IntPtr ptr = bitmapData.Scan0;
                int bytes = bitmapData.Stride * height;
                byte[] rgbValues = new byte[bytes];

                // Copy the data into RGB format.
                for (int row = 0; row &lt; height; ++row)
                {
                    int srcOffs = row * width;
                    int dstOffs = row * bitmapData.Stride;
                    for (int col = 0; col &lt; width; ++col)
                    {
                        rgbValues[dstOffs++] = data[srcOffs++];
                    }
                }

                System.Runtime.InteropServices.Marshal.Copy(rgbValues, 0, ptr, bytes);

                bitmap.UnlockBits(bitmapData);

                bitmap.SetResolution(480, 480);
                bitmap.Save(filename, ImageFormat.Tiff);
            }
        }

        static void SaveBMP(string filename, byte[] data, int width, int height)
        {
            using (var bitmap = new Bitmap(width, height, PixelFormat.Format8bppIndexed))
            {
                ColorPalette grayscalePalette = bitmap.Palette;
                for (int i = 0; i &lt; 256; ++i)
                {
                    grayscalePalette.Entries[i] = Color.FromArgb(i, i, i);
                }
                bitmap.Palette = grayscalePalette;

                Rectangle rect = new Rectangle(0, 0, width, height);
                BitmapData bitmapData = bitmap.LockBits(rect, ImageLockMode.WriteOnly, PixelFormat.Format8bppIndexed);

                IntPtr ptr = bitmapData.Scan0;
                int bytes = bitmapData.Stride * height;
                byte[] rgbValues = new byte[bytes];

                // Copy the data into RGB format.
                for (int row = 0; row &lt; height; ++row)
                {
                    int srcOffs = row * width;
                    int dstOffs = row * bitmapData.Stride;
                    for (int col = 0; col &lt; width; ++col)
                    {
                        rgbValues[dstOffs++] = data[srcOffs++];
                    }
                }

                System.Runtime.InteropServices.Marshal.Copy(rgbValues, 0, ptr, bytes);

                bitmap.UnlockBits(bitmapData);

                bitmap.SetResolution(480, 480);
                bitmap.Save(filename, ImageFormat.Bmp);
            }
        }

        static void SavePNG(string filename, byte[] data, int width, int height)
        {
            using (var bitmap = new Bitmap(width, height, PixelFormat.Format8bppIndexed))
            {
                ColorPalette grayscalePalette = bitmap.Palette;
                for (int i = 0; i &lt; 256; ++i)
                {
                    grayscalePalette.Entries[i] = Color.FromArgb(i, i, i);
                }
                bitmap.Palette = grayscalePalette;

                Rectangle rect = new Rectangle(0, 0, width, height);
                BitmapData bitmapData = bitmap.LockBits(rect, ImageLockMode.WriteOnly, PixelFormat.Format8bppIndexed);

                IntPtr ptr = bitmapData.Scan0;
                int bytes = bitmapData.Stride * height;
                byte[] rgbValues = new byte[bytes];

                // Copy the data into RGB format.
                for (int row = 0; row &lt; height; ++row)
                {
                    int srcOffs = row * width;
                    int dstOffs = row * bitmapData.Stride;
                    for (int col = 0; col &lt; width; ++col)
                    {
                        rgbValues[dstOffs++] = data[srcOffs++];
                    }
                }

                System.Runtime.InteropServices.Marshal.Copy(rgbValues, 0, ptr, bytes);

                bitmap.UnlockBits(bitmapData);

                bitmap.SetResolution(480, 480);
                bitmap.Save(filename, ImageFormat.Png);
            }
        }

        static void SaveRAW(string filename, byte[] data)
        {
            File.WriteAllBytes(filename, data);
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br></div></div><p>上述代码包含了4个函数，分别用于保存tiff、bmp、png和raw格式的图像文件。其中，tiff、bmp和png文件均需要使用System.Drawing命名空间下的相关类进行编写。</p> <p>主函数中，先读取24位RGB彩色图像数据，然后调用<code>ConvertTo8Bit</code>函数将其转换成8位灰度图像数据。最后分别调用保存函数将图像数据保存成不同格式的文件。其中，水平垂直分辨率都为480。</p> <p>需要注意的是，上述代码中只是做了简单的灰度值计算，如果需要更加精确的转换可以考虑使用其他的算法，如Luma通道计算。而在保存tiff、bmp和png文件时，还需要设置对应的256级灰度调色板。</p> <h3 id="_3-用c-实现黑白相机，彩色相机的图像深度转换和存储"><a href="#_3-用c-实现黑白相机，彩色相机的图像深度转换和存储" class="header-anchor">#</a> 3.用C++实现黑白相机，彩色相机的图像深度转换和存储</h3> <blockquote><p>C++ 把MONO12,Mono8,RGB16,RGB8 ,Mono10Packed,Mono12Packed的图像buffer 分别转化位8位，16位，24位的图像，并且保存为水平垂直分辨率为300的tiff,bmp,png,jpg,raw文件格式。</p></blockquote> <p>以下是C++代码实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;iostream&gt;
#include &lt;fstream&gt;

using namespace std;

// MONO10Packed和Mono12Packed的像素数据需要解包
void UnpackPixels(const unsigned char* src, unsigned char* dst, const int pixelCount, const int bitsPerPixel) {
    for (int i = 0; i &lt; pixelCount; ++i) {
        if (bitsPerPixel == 10) {
            dst[2 * i]     = src[5 * i] &lt;&lt; 2 | src[5 * i + 1] &gt;&gt; 6;
            dst[2 * i + 1] = (src[5 * i + 1] &amp; 0x3F) &lt;&lt; 2 | src[5 * i + 2] &gt;&gt; 6;
        } else if (bitsPerPixel == 12) {
            dst[2 * i]     = src[6 * i] &lt;&lt; 4 | src[6 * i + 1] &gt;&gt; 4;
            dst[2 * i + 1] = (src[6 * i + 1] &amp; 0x0F) &lt;&lt; 8 | src[6 * i + 2];
        }
    }
}

// 将单通道图像转换为8位或16位图像
void ConvertTo8or16Bit(const unsigned char* src, unsigned char* dst, const int pixelCount, const int bitsPerPixel) {
    if (bitsPerPixel == 8) {
        for (int i = 0; i &lt; pixelCount; ++i) {
            dst[i] = src[i];
        }
    } else if (bitsPerPixel == 16) {
        for (int i = 0; i &lt; pixelCount; ++i) {
            dst[2 * i] = src[i] &amp; 0xFF;
            dst[2 * i + 1] = src[i] &gt;&gt; 8;
        }
    }
}

// 将RGB图像转换为24位图像
void ConvertTo24Bit(const unsigned char* src, unsigned char* dst, const int pixelCount) {
    for (int i = 0; i &lt; pixelCount; ++i) {
        dst[3 * i] = src[3 * i + 2];
        dst[3 * i + 1] = src[3 * i + 1];
        dst[3 * i + 2] = src[3 * i];
    }
}

// 保存为tiff格式
void SaveAsTiff(const string&amp; filename, const unsigned char* data, const int width, const int height, const int bitsPerPixel) {
    TIFF* tiff = TIFFOpen(filename.c_str(), &quot;w&quot;);

    TIFFSetField(tiff, TIFFTAG_IMAGEWIDTH, width);
    TIFFSetField(tiff, TIFFTAG_IMAGELENGTH, height);
    TIFFSetField(tiff, TIFFTAG_SAMPLESPERPIXEL, 1);
    TIFFSetField(tiff, TIFFTAG_BITSPERSAMPLE, bitsPerPixel);
    TIFFSetField(tiff, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);
    TIFFSetField(tiff, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_MINISBLACK);
    TIFFSetField(tiff, TIFFTAG_COMPRESSION, COMPRESSION_LZW);
    TIFFSetField(tiff, TIFFTAG_XRESOLUTION, 300.0);
    TIFFSetField(tiff, TIFFTAG_YRESOLUTION, 300.0);
    TIFFSetField(tiff, TIFFTAG_RESOLUTIONUNIT, RESUNIT_INCH);

    TIFFSetField(tiff, TIFFTAG_ROWSPERSTRIP, TIFFDefaultStripSize(tiff, 0));
    TIFFSetField(tiff, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);

    const int bufferSize = width * height * bitsPerPixel / 8;
    TIFFWriteEncodedStrip(tiff, 0, (void*)data, bufferSize);

    TIFFClose(tiff);
}

// 保存为bmp格式
void SaveAsBmp(const string&amp; filename, const unsigned char* data, const int width, const int height, const int bitsPerPixel) {
    BITMAPFILEHEADER bmpFileHeader;
    bmpFileHeader.bfType = 0x4D42;
    bmpFileHeader.bfSize = sizeof(BITMAPFILEHEADER) + sizeof(BITMAPINFOHEADER) + width * height * bitsPerPixel / 8;
    bmpFileHeader.bfReserved1 = 0;
    bmpFileHeader.bfReserved2 = 0;
    bmpFileHeader.bfOffBits = sizeof(BITMAPFILEHEADER) + sizeof(BITMAPINFOHEADER);

    BITMAPINFOHEADER bmpInfoHeader;
    bmpInfoHeader.biSize = sizeof(BITMAPINFOHEADER);
    bmpInfoHeader.biWidth = width;
    bmpInfoHeader.biHeight = -height; // negative height to indicate top-down DIB
    bmpInfoHeader.biPlanes = 1;
    bmpInfoHeader.biBitCount = bitsPerPixel;
    bmpInfoHeader.biCompression = BI_RGB;
    bmpInfoHeader.biSizeImage = 0;
    bmpInfoHeader.biXPelsPerMeter = 300.0 / 0.0254;
    bmpInfoHeader.biYPelsPerMeter = 300.0 / 0.0254;
    bmpInfoHeader.biClrUsed = 0;
    bmpInfoHeader.biClrImportant = 0;

    ofstream ofs(filename, ios::binary);
    ofs.write(reinterpret_cast&lt;char*&gt;(&amp;bmpFileHeader), sizeof(BITMAPFILEHEADER));
    ofs.write(reinterpret_cast&lt;char*&gt;(&amp;bmpInfoHeader), sizeof(BITMAPINFOHEADER));
    ofs.write(reinterpret_cast&lt;const char*&gt;(data), width * height * bitsPerPixel / 8);
    ofs.close();
}

// 保存为png格式
void SaveAsPng(const string&amp; filename, const unsigned char* data, const int width, const int height, const int bitsPerPixel) {
    LodePNGColorType colorType;
    if (bitsPerPixel == 8) {
        colorType = LCT_GREY;
    } else if (bitsPerPixel == 16) {
        colorType = LCT_GREY_ALPHA;
    } else if (bitsPerPixel == 24) {
        colorType = LCT_RGB;
    }

    unsigned error = lodepng::encode(filename, data, width, height, colorType, 8);
    if (error) {
        cerr &lt;&lt; &quot;PNG encoding error: &quot; &lt;&lt; lodepng_error_text(error) &lt;&lt; endl;
    }
}

// 保存为jpeg格式
void SaveAsJpeg(const string&amp; filename, const unsigned char* data, const int width, const int height, const int bitsPerPixel) {
    struct jpeg_compress_struct cinfo;
    struct jpeg_error_mgr jerr;

    FILE* outfile;
    if ((outfile = fopen(filename.c_str(), &quot;wb&quot;)) == NULL) {
        cerr &lt;&lt; &quot;Cannot open JPEG file&quot; &lt;&lt; endl;
        return;
    }

    cinfo.err = jpeg_std_error(&amp;jerr);
    jpeg_create_compress(&amp;cinfo);
    jpeg_stdio_dest(&amp;cinfo, outfile);

    cinfo.image_width = width;
    cinfo.image_height = height;
    if (bitsPerPixel == 8) {
        cinfo.input_components = 1;
        cinfo.in_color_space = JCS_GRAYSCALE;
    } else if (bitsPerPixel == 24) {
        cinfo.input_components = 3;
        cinfo.in_color_space = JCS_RGB;
    }
    jpeg_set_defaults(&amp;cinfo);
    jpeg_set_quality(&amp;cinfo, 90, true);
    jpeg_start_compress(&amp;cinfo, true);

    JSAMPROW row_pointer[1];
    int row_stride;
    if (bitsPerPixel == 8) {
        row_stride = width;
    } else if (bitsPerPixel == 24) {
        row_stride = 3 * width;
    }
    while (cinfo.next_scanline &lt; cinfo.image_height) {
        row_pointer[0] = const_cast&lt;JSAMPROW&gt;(&amp;data[cinfo.next_scanline * row_stride]);
        jpeg_write_scanlines(&amp;cinfo, row_pointer, 1);
    }

    jpeg_finish_compress(&amp;cinfo);
    fclose(outfile);
}

// 保存为raw格式
void SaveAsRaw(const string&amp; filename, const unsigned char* data, const int width, const int height, const int bitsPerPixel) {
    ofstream ofs(filename, ios::binary);
    ofs.write(reinterpret_cast&lt;const char*&gt;(data), width * height * bitsPerPixel / 8);
    ofs.close();
}

int main() {
    const string inputFilename = &quot;test.rgb&quot;;
    const string outputFilenamePrefix = &quot;test&quot;;

    const int width = 640;
    const int height = 480;

    const int pixelCount = width * height;

    // 读取图像数据
    ifstream ifs(inputFilename, ios::binary);
    unsigned char* rawData = new unsigned char[3 * pixelCount];
    ifs.read(reinterpret_cast&lt;char*&gt;(rawData), 3 * pixelCount);
    ifs.close();

    // 分配内存并转换图像格式
    unsigned char* outputData8 = new unsigned char[pixelCount];
    unsigned char* outputData16 = new unsigned char[2 * pixelCount];
    unsigned char* outputData24 = new unsigned char[3 * pixelCount];

    unsigned char* unpackedData = new unsigned char[pixelCount];
    UnpackPixels(rawData, unpackedData, pixelCount, 10); // 对于Mono10Packed图像需要解包
    ConvertTo8or16Bit(unpackedData, outputData8, pixelCount, 8);
    ConvertTo8or16Bit(unpackedData, outputData16, pixelCount, 16);

    UnpackPixels(rawData, unpackedData, pixelCount, 12); // 对于Mono12Packed图像需要解包
    ConvertTo8or16Bit(unpackedData, outputData8, pixelCount, 8);
    ConvertTo8or16Bit(unpackedData, outputData16, pixelCount, 16);

    ConvertTo8or16Bit(rawData, outputData8, pixelCount, 8);
    ConvertTo8or16Bit(rawData, outputData16, pixelCount, 16);

    ConvertTo24Bit(rawData, outputData24, pixelCount);

    // 保存为不同格式的图像文件
    SaveAsTiff(outputFilenamePrefix + &quot;_8bit.tif&quot;, outputData8, width, height, 8);
    SaveAsBmp(outputFilenamePrefix + &quot;_8bit.bmp&quot;, outputData8, width, height, 8);
    SaveAsPng(outputFilenamePrefix + &quot;_8bit.png&quot;, outputData8, width, height, 8);
    SaveAsJpeg(outputFilenamePrefix + &quot;_8bit.jpg&quot;, outputData8, width, height, 8);
    SaveAsRaw(outputFilenamePrefix + &quot;_8bit.raw&quot;, outputData8, width, height, 8);

    SaveAsTiff(outputFilenamePrefix + &quot;_16bit.tif&quot;, outputData16, width, height, 16);
    SaveAsBmp(outputFilenamePrefix + &quot;_16bit.bmp&quot;, outputData16, width, height, 16);
    SaveAsPng(outputFilenamePrefix + &quot;_16bit.png&quot;, outputData16, width, height, 16);
    SaveAsJpeg(outputFilenamePrefix + &quot;_16bit.jpg&quot;, outputData16, width, height, 16);
    SaveAsRaw(outputFilenamePrefix + &quot;_16bit.raw&quot;, outputData16, width, height, 16);
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br></div></div><h3 id="_4-工业相机图像格式的数据存储原理"><a href="#_4-工业相机图像格式的数据存储原理" class="header-anchor">#</a> 4. 工业相机图像格式的数据存储原理</h3> <p>MONO12图像buffer存储结构和原理、Mono8图像buffer存储结构和原理、RGB16图像buffer存储结构和原理、RGB8图像buffer存储结构和原理</p> <p>以下是各种图像buffer存储结构和原理的整理：</p> <ul><li>MONO8（单通道8位）：每个像素点只有一个通道，通道值的范围是0-255，使用一个字节存储。</li> <li>MONO10Packed（单通道10位压缩）：每个像素点只有一个通道，通道值的范围是0-1023，使用2个字节存储。其中，每三个像素点的数据会被压缩为4个字节，即将30位的像素数据压缩为24位进行存储。</li> <li>MONO12（单通道12位）：每个像素点只有一个通道，通道值的范围是0-4095，使用2个字节存储。</li> <li>MONO12Packed（单通道12位压缩）：每个像素点只有一个通道，通道值的范围是0-4095，使用3个字节存储。其中，每两个像素点的数据会被压缩为3个字节，即将24位的像素数据压缩为18位进行存储。</li> <li>RGB8（三通道8位）：每个像素点有三个通道，分别是红、绿、蓝三个通道，每个通道的像素值范围是0-255，总共使用三个字节存储。</li> <li>RGB16（三通道16位）：每个像素点有三个通道，分别是红、绿、蓝三个通道，每个通道的像素值范围是0-65535，总共使用六个字节存储。</li></ul> <p>以上是各种图像buffer的存储结构和原理的整理。需要特别说明的是，MONO10Packed和MONO12Packed采用了压缩算法进行存储，可以在一定程度上减少存储空间的占用。此外，RGB8和RGB16是三通道的图像格式，分别对应红、绿、蓝三个颜色通道，每个通道的像素值都可以在0-255或0-65535之间变化。</p> <h3 id="_5-24位图像处理"><a href="#_5-24位图像处理" class="header-anchor">#</a> 5. 24位图像处理</h3> <blockquote><p>用C# 把24位的彩色相机buffer分别转化为8位，16位，24位的buffer，并且分别保存图像为tiff,jpg,png,raw,bmp文件，水平垂直分辨率为96</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>using System;
using System.Drawing;
using System.Drawing.Imaging;

public static class ColorCameraBufferConverter
{
    public static void ConvertTo8Bit(byte[] inputBuffer, byte[] outputBuffer)
    {
        for (int i = 0; i &lt; inputBuffer.Length; i += 3)
        {
            byte r = inputBuffer[i];
            byte g = inputBuffer[i + 1];
            byte b = inputBuffer[i + 2];

            byte gray = (byte)(0.299 * r + 0.587 * g + 0.114 * b);

            outputBuffer[i / 3] = gray;
        }
    }

    public static void ConvertTo16Bit(byte[] inputBuffer, byte[] outputBuffer)
    {
        for (int i = 0; i &lt; inputBuffer.Length; i += 3)
        {
            byte r = inputBuffer[i];
            byte g = inputBuffer[i + 1];
            byte b = inputBuffer[i + 2];

            ushort red16 = (ushort)(r &lt;&lt; 8);
            ushort green16 = (ushort)(g &lt;&lt; 8);
            ushort blue16 = (ushort)(b &lt;&lt; 8);

            outputBuffer[i * 2] = (byte)red16;
            outputBuffer[i * 2 + 1] = (byte)(red16 &gt;&gt; 8);
            outputBuffer[i * 2 + 2] = (byte)green16;
            outputBuffer[i * 2 + 3] = (byte)(green16 &gt;&gt; 8);
            outputBuffer[i * 2 + 4] = (byte)blue16;
            outputBuffer[i * 2 + 5] = (byte)(blue16 &gt;&gt; 8);
        }
    }

    public static void ConvertTo24Bit(byte[] inputBuffer, byte[] outputBuffer)
    {
        Array.Copy(inputBuffer, outputBuffer, inputBuffer.Length);
    }

    public static void SaveToTiff(byte[] buffer, int width, int height, string fileName, long compression = EncoderValue.CompressionLZW)
    {
        using (Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format24bppRgb))
        {
            BitmapData bitmapData = bitmap.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, bitmap.PixelFormat);

            try
            {
                int stride = bitmapData.Stride; // 行字节宽度

                for (int y = 0; y &lt; height; y++)
                {
                    byte[] lineBuffer = new byte[stride];

                    Array.Copy(buffer, y * stride, lineBuffer, 0, stride);

                    for (int x = 0; x &lt; width; x++)
                    {
                        // RGB顺序
                        int index1 = x * 3;
                        int index2 = y * stride + x * 3;
                        lineBuffer[index1] = buffer[index2 + 2];
                        lineBuffer[index1 + 1] = buffer[index2 + 1];
                        lineBuffer[index1 + 2] = buffer[index2];
                    }

                    System.Runtime.InteropServices.Marshal.Copy(lineBuffer, 0, (IntPtr)(bitmapData.Scan0 + y * stride), stride);
                }

                SaveTiff(bitmap, fileName, compression);
            }
            finally
            {
                bitmap.UnlockBits(bitmapData);
            }
        }
    }

    public static void SaveToJpeg(byte[] buffer, int width, int height, string fileName, int quality = 80)
    {
        using (Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format24bppRgb))
        {
            BitmapData bitmapData = bitmap.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, bitmap.PixelFormat);

            try
            {
                int stride = bitmapData.Stride; // 行字节宽度

                for (int y = 0; y &lt; height; y++)
                {
                    byte[] lineBuffer = new byte[stride];

                    Array.Copy(buffer, y * stride, lineBuffer, 0, stride);

                    for (int x = 0; x &lt; width; x++)
                    {
                        // RGB顺序
                        int index1 = x * 3;
                        int index2 = y * stride + x * 3;
                        lineBuffer[index1] = buffer[index2 + 2];
                        lineBuffer[index1 + 1] = buffer[index2 + 1];
                        lineBuffer[index1 + 2] = buffer[index2];
                    }

                    System.Runtime.InteropServices.Marshal.Copy(lineBuffer, 0, (IntPtr)(bitmapData.Scan0 + y * stride), stride);
                }

                SaveJpeg(bitmap, fileName, quality);
            }
            finally
            {
                bitmap.UnlockBits(bitmapData);
            }
        }
    }

    public static void SaveToPng(byte[] buffer, int width, int height, string fileName)
    {
        using (Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format24bppRgb))
        {
            BitmapData bitmapData = bitmap.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, bitmap.PixelFormat);

            try
            {
                int stride = bitmapData.Stride; // 行字节宽度

                for (int y = 0; y &lt; height; y++)
                {
                    byte[] lineBuffer = new byte[stride];

                    Array.Copy(buffer, y * stride, lineBuffer, 0, stride);

                    for (int x = 0; x &lt; width; x++)
                    {
                        // RGB顺序
                        int index1 = x * 3;
                        int index2 = y * stride + x * 3;
                        lineBuffer[index1] = buffer[index2 + 2];
                        lineBuffer[index1 + 1] = buffer[index2 + 1];
                        lineBuffer[index1 + 2] = buffer[index2];
                    }

                    System.Runtime.InteropServices.Marshal.Copy(lineBuffer, 0, (IntPtr)(bitmapData.Scan0 + y * stride), stride);
                }

                bitmap.Save(fileName, ImageFormat.Png);
            }
            finally
            {
                bitmap.UnlockBits(bitmapData);
            }
        }
    }

    public static void SaveToRaw(byte[] buffer, string fileName)
    {
        System.IO.File.WriteAllBytes(fileName, buffer);
    }

    public static void SaveToBmp(byte[] buffer, int width, int height, string fileName)
    {
        using (Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format24bppRgb))
        {
            BitmapData bitmapData = bitmap.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.WriteOnly, bitmap.PixelFormat);

            try
            {
                int stride = bitmapData.Stride; // 行字节宽度

                for (int y = 0; y &lt; height; y++)
                {
                    byte[] lineBuffer = new byte[stride];

                    Array.Copy(buffer, y * stride, lineBuffer, 0, stride);

                    for (int x = 0; x &lt; width; x++)
                    {
                        // RGB顺序
                        int index1 = x * 3;
                        int index2 = y * stride + x * 3;
                        lineBuffer[index1] = buffer[index2 + 2];
                        lineBuffer[index1 + 1] = buffer[index2 + 1];
                        lineBuffer[index1 + 2] = buffer[index2];
                    }

                    System.Runtime.InteropServices.Marshal.Copy(lineBuffer, 0, (IntPtr)(bitmapData.Scan0 + y * stride), stride);
                }

                bitmap.Save(fileName, ImageFormat.Bmp);
            }
            finally
            {
                bitmap.UnlockBits(bitmapData);
            }
        }
    }

    private static void SaveTiff(Bitmap bitmap, string fileName, long compression)
    {
        EncoderParameters encoderParameters = new EncoderParameters(1);
        encoderParameters.Param[0] = new EncoderParameter(Encoder.Compression, compression);

        ImageCodecInfo myImageCodecInfo = GetEncoderInfo(&quot;image/tiff&quot;);

        bitmap.Save(fileName, myImageCodecInfo, encoderParameters);
    }

    private static void SaveJpeg(Bitmap bitmap, string fileName, int quality)
    {
        EncoderParameters encoderParameters = new EncoderParameters(1);
        encoderParameters.Param[0] = new EncoderParameter(Encoder.Quality, quality);

        ImageCodecInfo myImageCodecInfo = GetEncoderInfo(&quot;image/jpeg&quot;);

        bitmap.Save(fileName, myImageCodecInfo, encoderParameters);
    }

    private static ImageCodecInfo GetEncoderInfo(string mimeType)
    {
        ImageCodecInfo[] encoders = ImageCodecInfo.GetImageEncoders();

        for (int i = 0; i &lt; encoders.Length; i++)
        {
            if (encoders[i].MimeType == mimeType)
            {
                return encoders[i];
            }
        }

        return null;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br></div></div><p>调用示例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>csharpCopy Code// 假设width和height已知并且是24位彩色图像的大小
byte[] inputBuffer = ... // 24位彩色图像buffer

byte[] outputBuffer1 = new byte[width * height];
byte[] outputBuffer2 = new byte[width * height * 2];
byte[] outputBuffer3 = new byte[width * height * 3];

ColorCameraBufferConverter.ConvertTo8Bit(inputBuffer, outputBuffer1);
ColorCameraBufferConverter.ConvertTo16Bit(inputBuffer, outputBuffer2);
ColorCameraBufferConverter.ConvertTo24Bit(inputBuffer, outputBuffer3);

string tiffFileName = &quot;output.tiff&quot;;
string jpegFileName = &quot;output.jpg&quot;;
string pngFileName = &quot;output.png&quot;;
string rawFileName = &quot;output.raw&quot;;
string bmpFileName = &quot;output.bmp&quot;;

int horizontalResolution = 96;
int verticalResolution = 96;

ColorCameraBufferConverter.SaveToTiff(outputBuffer1, width, height, tiffFileName);
ColorCameraBufferConverter.SaveToJpeg(outputBuffer1, width, height, jpegFileName);
ColorCameraBufferConverter.SaveToPng(outputBuffer1, width, height, pngFileName);
ColorCameraBufferConverter.SaveToRaw(outputBuffer1, rawFileName);
ColorCameraBufferConverter.SaveToBmp(outputBuffer1, width, height, bmpFileName);

// 保存时指定水平垂直分辨率
SaveToTiff(outputBuffer1, width, height, tiffFileName, horizontalResolution, verticalResolution);
SaveToJpeg(outputBuffer1, width, height, jpegFileName, horizontalResolution, verticalResolution);
SaveToPng(outputBuffer1, width, height, pngFileName, horizontalResolution, verticalResolution);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>来源链接：[<a href="https://en.wikipedia.org/wiki/The_C_Programming_Language" target="_blank" rel="noopener noreferrer">1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>] [<a href="https://www.zhihu.com/question/26553263" target="_blank" rel="noopener noreferrer">2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>] [<a href="https://zhuanlan.zhihu.com/p/72581663" target="_blank" rel="noopener noreferrer">3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>] [<a href="https://en.wikipedia.org/wiki/8-bit_computing" target="_blank" rel="noopener noreferrer">4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>]</p> <p>-<a href="https://www.cnblogs.com/ybqjymy/p/13672531.html" target="_blank" rel="noopener noreferrer">LIBTIFF库的使用心得 - 一杯清酒邀明月 - 博客园 (cnblogs.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.4da30dd0.js" defer></script><script src="/assets/js/5.11d7f905.js" defer></script>
  </body>
</html>
