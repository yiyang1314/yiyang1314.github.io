<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1.用C#把Mono12Packed的buffer 保存为16位的tiff 图 | 易陽羽博客平台</title>
    <meta name="description" content="易陽羽博客平台">
    <link rel="icon" href="/images/test.jpg">
  <link rel="manifest" href="/images/test.jpg">
  <link rel="apple-touch-icon" href="/images/test.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.c9120bc4.css" as="style"><link rel="preload" href="/assets/js/app.4da30dd0.js" as="script"><link rel="preload" href="/assets/js/4.a57a78a9.js" as="script"><link rel="prefetch" href="/assets/js/10.cfc7b205.js"><link rel="prefetch" href="/assets/js/11.cb8ae4bc.js"><link rel="prefetch" href="/assets/js/12.ab3ecb05.js"><link rel="prefetch" href="/assets/js/13.86f17a9a.js"><link rel="prefetch" href="/assets/js/14.ded0f1b1.js"><link rel="prefetch" href="/assets/js/15.86569fc0.js"><link rel="prefetch" href="/assets/js/16.38bf9bf2.js"><link rel="prefetch" href="/assets/js/2.33d9b4c1.js"><link rel="prefetch" href="/assets/js/3.b0ae39a2.js"><link rel="prefetch" href="/assets/js/5.11d7f905.js"><link rel="prefetch" href="/assets/js/6.adf1cbb1.js"><link rel="prefetch" href="/assets/js/7.1581cf2f.js"><link rel="prefetch" href="/assets/js/8.3ca4c508.js"><link rel="prefetch" href="/assets/js/9.93f8b21b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9120bc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">易陽羽博客平台</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link router-link-active">JAVA知识</a></div><div class="nav-item"><a href="/others/" class="nav-link">前端开发</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">Dotnet软件开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">机器视觉开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">上位机开发</a></div><div class="nav-item"><a href="https://www.cnblogs.com/yiyangyu/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  易陽羽
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link router-link-active">JAVA知识</a></div><div class="nav-item"><a href="/others/" class="nav-link">前端开发</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">Dotnet软件开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">机器视觉开发</a></div><div class="nav-item"><a href="/others/" class="nav-link">上位机开发</a></div><div class="nav-item"><a href="https://www.cnblogs.com/yiyangyu/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  易陽羽
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>1.用C#把Mono12Packed的buffer 保存为16位的tiff 图</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/accumulate/1.html#_1-用c-把mono12packed的buffer-保存为16位的tiff-图" class="sidebar-link">1.用C#把Mono12Packed的buffer 保存为16位的tiff 图</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/accumulate/1.html#_2用c-把mono12的buffer-保存为16位的bmp-tiff-png-raw-jpeg-文件，封装为动态库dll，并使用c-，java-jna调用存图接口" class="sidebar-link">2用C++ 把Mono12的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#，JAVA Jna调用存图接口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/accumulate/1.html#c-动态库" class="sidebar-link">C++ 动态库</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/accumulate/1.html#c-调用" class="sidebar-link">C# 调用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/accumulate/1.html#java-jna-调用" class="sidebar-link">Java JNA 调用</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="_1-用c-把mono12packed的buffer-保存为16位的tiff-图"><a href="#_1-用c-把mono12packed的buffer-保存为16位的tiff-图" class="header-anchor">#</a> 1.用C#把Mono12Packed的buffer 保存为16位的tiff 图</h2> <p>以下是将Mono12Packed缓冲区保存为16位TIFF图像的C#代码示例。在这个例子中，我们使用了FreeImage库来处理图像数据和文件IO。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>csharp复制代码using System;
using System.Runtime.InteropServices;
using FreeImageAPI;

// 定义Mono12Packed数据结构
[StructLayout(LayoutKind.Sequential, Pack = 1)]
public struct Mono12PackedPixel
{
    public byte LSB;
    public byte MSB;
}
 
class Program
{
    static void Main(string[] args)
    {
        // 假设我们已经有了Mono12Packed的数据缓冲区和图像尺寸信息
        Mono12PackedPixel[] imageData; // 缓冲区
        int width, height; // 图像宽高

        // 转换到16位灰度
        ushort[] imageData16 = new ushort[width * height];
        for(int i = 0; i &lt; imageData.Length; i++)
        {
            Mono12PackedPixel pixel = imageData[i];
            ushort value = (ushort)((pixel.MSB &lt;&lt; 8) | pixel.LSB);
            imageData16[i] = value &lt;&lt; 4; // 由12位转换成16位，左移4位
        }

        // 使用FreeImage创建一个16位灰度图像
        FIBITMAP image = FreeImage.AllocateT(FREE_IMAGE_TYPE.FIT_UINT16, width, height, 16);

        // 将数据缓冲区写入图像
        FreeImage.ConvertFromRawBitsEx(true, imageData16, image, width * sizeof(ushort), 16, 0xFF00, 0x00FF, 0xFF0000);

        // 保存图像为TIFF文件
        FreeImage.Save(FREE_IMAGE_FORMAT.FIF_TIFF, image, &quot;output.tif&quot;, FREE_IMAGE_SAVE_FLAGS.TIFF_DEFAULT);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这个例子中，我们将Mono12Packed缓冲区的数据先转换为16位灰度值，然后使用FreeImage库来创建一个16位灰度图像，最后将数据写入并保存为TIFF格式的文件。请注意，这里将数据由</p> <h2 id="_2用c-把mono12的buffer-保存为16位的bmp-tiff-png-raw-jpeg-文件，封装为动态库dll，并使用c-，java-jna调用存图接口"><a href="#_2用c-把mono12的buffer-保存为16位的bmp-tiff-png-raw-jpeg-文件，封装为动态库dll，并使用c-，java-jna调用存图接口" class="header-anchor">#</a> 2用C++ 把Mono12的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#，JAVA Jna调用存图接口</h2> <p>用C#把Mono12Packed的buffer 保存为16位的tiff 图像</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>要将Mono12Packed格式的缓冲区保存为16位的TIFF图像，可以使用以下步骤：</p> <ol><li><p>安装System.Drawing.Common和BitMiracle.LibTiff.Net库，以处理TIFF图像。在Visual Studio中，转到“工具”&gt;“NuGet包管理器”&gt;“管理解决方案的NuGet包”，然后搜索并安装这两个库。或者，在命令行中使用以下命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet add package System.Drawing.Common
dotnet add package BitMiracle.LibTiff.NET
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>使用以下代码将Mono12Packed缓冲区转换为16位缓冲区：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ConvertMono12PackedTo16Bit</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12PackedBuffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">int</span></span> pixelCount <span class="token operator">=</span> width <span class="token operator">*</span> height<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> outputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">ushort</span></span><span class="token punctuation">[</span>pixelCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> packedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> outputIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>outputIndex <span class="token operator">&lt;</span> pixelCount<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Unpack 3 bytes into 2 12-bit values</span>
        <span class="token class-name"><span class="token keyword">ushort</span></span> firstPixel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>packedIndex<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>packedIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">ushort</span></span> secondPixel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>packedIndex <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>packedIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputBuffer<span class="token punctuation">[</span>outputIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstPixel<span class="token punctuation">;</span>
        outputBuffer<span class="token punctuation">[</span>outputIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> secondPixel<span class="token punctuation">;</span>

        packedIndex <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> outputBuffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li> <li><p>使用以下代码将16位缓冲区保存为TIFF图像：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Drawing</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Drawing<span class="token punctuation">.</span>Imaging</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">BitMiracle<span class="token punctuation">.</span>LibTiff<span class="token punctuation">.</span>Classic</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Save16BitBufferToTiff</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fileName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Tiff</span> tiff <span class="token operator">=</span> Tiff<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>IMAGEWIDTH<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>IMAGELENGTH<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>BITSPERSAMPLE<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>SAMPLESPERPIXEL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>ROWSPERSTRIP<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>COMPRESSION<span class="token punctuation">,</span> Compression<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>PHOTOMETRIC<span class="token punctuation">,</span> Photometric<span class="token punctuation">.</span>MINISBLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>FILLORDER<span class="token punctuation">,</span> FillOrder<span class="token punctuation">.</span>MSB2LSB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>TiffTag<span class="token punctuation">.</span>PLANARCONFIG<span class="token punctuation">,</span> PlanarConfig<span class="token punctuation">.</span>CONTIG<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> outputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Buffer<span class="token punctuation">.</span><span class="token function">BlockCopy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outputBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outputBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tiff<span class="token punctuation">.</span><span class="token function">WriteRawStrip</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> outputBuffer<span class="token punctuation">,</span> outputBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li></ol></li></ul> <p>用C#把Mono12Packed的buffer 保存为16位的tiff 图像</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>为了将 Mono12Packed 缓冲区保存为 16 位的 TIFF 图像，我们需要执行以下步骤：</p> <ol><li>将 Mono12Packed 缓冲区转换为 16 位的数据。</li> <li>使用支持 16 位 TIFF 图像的库（如<code>ImageSharp</code>）创建一个新的图像。</li> <li>将数据写入新的 TIFF 图像。</li> <li>将 TIFF 图像保存到文件。</li></ol> <p>首先，你需要在项目中安装 <code>ImageSharp</code> 库。在 Visual Studio 中，右键单击项目并选择 &quot;Manage NuGet Packages&quot;，搜索 &quot;ImageSharp&quot; 并安装它。或者，你可以使用以下命令在命令行中安装：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet add package SixLabors.ImageSharp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一旦安装了 <code>ImageSharp</code>，你可以使用以下代码将 Mono12Packed 缓冲区保存为 16 位的 TIFF 图像：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">SixLabors<span class="token punctuation">.</span>ImageSharp</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">SixLabors<span class="token punctuation">.</span>ImageSharp<span class="token punctuation">.</span>PixelFormats</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">SixLabors<span class="token punctuation">.</span>ImageSharp<span class="token punctuation">.</span>Processing</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SaveMono12PackedBufferAsTiff</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12PackedBuffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> outputPath<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Step 1: Convert Mono12Packed buffer to 16-bit data.</span>
    <span class="token class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data16Bit <span class="token operator">=</span> <span class="token function">ConvertMono12PackedTo16Bit</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step 2: Create a new image with the 16-bit data.</span>
    <span class="token keyword">using</span> <span class="token class-name">Image<span class="token punctuation">&lt;</span>Gray16<span class="token punctuation">&gt;</span></span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Image<span class="token punctuation">&lt;</span>Gray16<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span>Default<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step 3: Write the 16-bit data to the image.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">int</span></span> dataIndex <span class="token operator">=</span> y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">;</span>
            image<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Gray16</span><span class="token punctuation">(</span>data16Bit<span class="token punctuation">[</span>dataIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 4: Save the image as a TIFF file.</span>
    <span class="token keyword">using</span> <span class="token class-name">FileStream</span> output <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenWrite</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    image<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SixLabors<span class="token punctuation">.</span>ImageSharp<span class="token punctuation">.</span>Formats<span class="token punctuation">.</span>Tiff<span class="token punctuation">.</span>TiffEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ConvertMono12PackedTo16Bit</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12PackedBuffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">int</span></span> inputLength <span class="token operator">=</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">.</span>Length <span class="token operator">!=</span> inputLength<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid buffer length for the specified width and height.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name"><span class="token keyword">ushort</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">ushort</span></span><span class="token punctuation">[</span>width <span class="token operator">*</span> height<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> outputIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">ushort</span></span> firstPixel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">ushort</span></span> secondPixel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xF0</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        output<span class="token punctuation">[</span>outputIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstPixel<span class="token punctuation">;</span>
        output<span class="token punctuation">[</span>outputIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> secondPixel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>现在你可以使用 <code>SaveMono12PackedBufferAsTiff</code> 函数将 Mono12Packed 缓冲区保存为 16 位的 TIFF 图像。例如：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12PackedBuffer <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// Your Mono12Packed data</span>
<span class="token class-name"><span class="token keyword">int</span></span> width <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// Image width</span>
<span class="token class-name"><span class="token keyword">int</span></span> height <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// Image height</span>
<span class="token class-name"><span class="token keyword">string</span></span> outputPath <span class="token operator">=</span> <span class="token string">&quot;output.tif&quot;</span><span class="token punctuation">;</span>

<span class="token function">SaveMono12PackedBufferAsTiff</span><span class="token punctuation">(</span>mono12PackedBuffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这将会将 Mono12Packed 缓冲区保存为 16 位的 TIFF 图像。</p></li></ul> <p>用C++ 把Mono12的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#，JAVA Jna调用存图接口</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>本回答将提供一个C++的动态库实现，用于将Mono12的buffer保存为16位的bmp、tiff、png、raw和jpeg文件。然后提供C#和Java的示例代码，展示如何调用这个动态库。</p> <p>首先，创建一个C++项目并将其设置为动态库。</p> <ol><li>使用以下代码编写<code>ImageSaver.h</code>文件：</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">IMAGESAVER_EXPORTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGESAVER_API</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGESAVER_API</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllimport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
    IMAGESAVER_API <span class="token keyword">bool</span> <span class="token function">SaveAsBMP</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IMAGESAVER_API <span class="token keyword">bool</span> <span class="token function">SaveAsTIFF</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IMAGESAVER_API <span class="token keyword">bool</span> <span class="token function">SaveAsPNG</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IMAGESAVER_API <span class="token keyword">bool</span> <span class="token function">SaveAsRAW</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IMAGESAVER_API <span class="token keyword">bool</span> <span class="token function">SaveAsJPEG</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol><li>使用以下代码编写<code>ImageSaver.cpp</code>文件：</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ImageSaver.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>

<span class="token keyword">bool</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">image</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_16UC1<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">{</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_PNG_COMPRESSION<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG_PROGRESSIVE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG_OPTIMIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF_COMPRESSION<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">SaveAsBMP</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_BMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">SaveAsTIFF</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">SaveAsPNG</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_PNG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">SaveAsRAW</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    file<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">SaveAsJPEG</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ol><li>编译项目以生成动态库（例如<code>ImageSaver.dll</code>）。</li></ol> <p>接下来，使用C#和Java调用动态库。</p> <p>C# 代码示例：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ImageSaver</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;ImageSaver.dll&quot;</span><span class="token punctuation">,</span> CallingConvention <span class="token operator">=</span> CallingConvention<span class="token punctuation">.</span>Cdecl<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">SaveAsBMP</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filename<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span>DllImport
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul> <p>用C++ 把Mono12的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#，JAVA Jna调用存图接口</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>首先，我们需要使用C++创建一个动态库，它可以将Mono12格式的缓冲区保存为16位的bmp, tiff, png, raw, jpeg文件。然后，我们将使用C#和Java JNA调用此动态库中的函数。</p> <h2 id="c-动态库"><a href="#c-动态库" class="header-anchor">#</a> C++ 动态库</h2> <ol><li>创建一个新的C++项目，将其命名为<code>Mono12ToImage</code>，并将其类型设置为“动态库”。</li> <li>添加以下依赖库：</li></ol> <ul><li>OpenCV（用于图像处理和保存）</li> <li>libtiff（用于处理tiff文件）</li></ul> <ol><li>在项目中创建一个名为<code>Mono12ToImage.h</code>的头文件，并添加以下内容：</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">MONO12TOIMAGE_EXPORTS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MONO12TOIMAGE_API</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MONO12TOIMAGE_API</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllimport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
    MONO12TOIMAGE_API <span class="token keyword">int</span> <span class="token function">saveImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mono12Buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> outputPath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol><li>创建一个名为<code>Mono12ToImage.cpp</code>的源文件，并添加以下内容：</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Mono12ToImage.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">saveImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> mono12Buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> outputPath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将Mono12的buffer转换为16位的cv::Mat</span>
    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">mono12Image</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_16UC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: 将mono12Buffer转换为mono12Image</span>

    <span class="token comment">// 保存图像</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> compression_params<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">formatStr</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>formatStr <span class="token operator">==</span> <span class="token string">&quot;bmp&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_BMP_DEPTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>formatStr <span class="token operator">==</span> <span class="token string">&quot;tiff&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF_COMPRESSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF_DEFLATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>formatStr <span class="token operator">==</span> <span class="token string">&quot;png&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_PNG_COMPRESSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>formatStr <span class="token operator">==</span> <span class="token string">&quot;jpeg&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>formatStr <span class="token operator">==</span> <span class="token string">&quot;raw&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO: 保存为raw格式</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> mono12Image<span class="token punctuation">,</span> compression_params<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>注意：这段代码仅仅提供了一个框架，您需要自行实现将mono12Buffer转换为mono12Image的代码。</p> <ol><li>编译项目以生成Mono12ToImage.dll。</li></ol> <h2 id="c-调用"><a href="#c-调用" class="header-anchor">#</a> C# 调用</h2> <ol><li>在C#项目中添加对Mono12ToImage.dll的引用：</li></ol> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mono12ToImageWrapper</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Mono12ToImage.dll&quot;</span><span class="token punctuation">,</span> CallingConvention <span class="token operator">=</span> CallingConvention<span class="token punctuation">.</span>Cdecl<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">saveImage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12Buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> outputPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li>调用Mono12ToImageWrapper.saveImage方法将Mono12的缓冲区保存为图像：</li></ol> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> mono12Buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 示例缓冲区</span>
<span class="token class-name"><span class="token keyword">string</span></span> outputPath <span class="token operator">=</span> <span class="token string">&quot;output.bmp&quot;</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">string</span></span> format <span class="token operator">=</span> <span class="token string">&quot;bmp&quot;</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">int</span></span> result <span class="token operator">=</span> Mono12ToImageWrapper<span class="token punctuation">.</span><span class="token function">saveImage</span><span class="token punctuation">(</span>mono12Buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> outputPath<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Image saved successfully!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save image.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="java-jna-调用"><a href="#java-jna-调用" class="header-anchor">#</a> Java JNA 调用</h2> <ol><li>添加JNA依赖库（Maven）：</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.java.dev.jna<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jna<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li>创建一个名为<code>Mono12ToImageLibrary.java</code>的接口，并添加以下内容：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jna<span class="token punctuation">.</span></span><span class="token class-name">Library</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jna<span class="token punctuation">.</span></span><span class="token class-name">Native</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Mono12ToImageLibrary</span> <span class="token keyword">extends</span> <span class="token class-name">Library</span> <span class="token punctuation">{</span>
    <span class="token class-name">Mono12ToImageLibrary</span> <span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Mono12ToImageLibrary</span><span class="token punctuation">)</span> <span class="token class-name">Native</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;Mono12ToImage&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Mono12ToImageLibrary</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">saveImage</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mono12Buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token class-name">String</span> outputPath<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>调用Mono12ToImageLibrary.INSTANCE.saveImage方法将Mono12的缓冲区保存为图像：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mono12Buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 示例缓冲区</span>
<span class="token class-name">String</span> outputPath <span class="token operator">=</span> <span class="token string">&quot;output.bmp&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> format <span class="token operator">=</span> <span class="token string">&quot;bmp&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">Mono12ToImageLibrary</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">saveImage</span><span class="token punctuation">(</span>mono12Buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> outputPath<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Image saved successfully!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save image.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>注意：在运行Java程序之前，请确保Mono12ToImage.dll位于系统路径或Java库路径中。</p></li></ul> <p>用C++ 把Mono12Packed的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#调用存图接口</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>为了实现这个功能，我们将使用以下库：</p> <ol><li>OpenCV：用于图像处理和转换。</li> <li>CMake：用于生成跨平台的编译系统。</li></ol> <p>首先，确保已经在系统中安装了OpenCV。接下来，创建一个名为<code>SaveImage</code>的项目，并在其中创建以下文件：</p> <ol><li><code>CMakeLists.txt</code>：CMake配置文件。</li> <li><code>save_image.h</code>：头文件，声明导出函数。</li> <li><code>save_image.cpp</code>：源文件，实现保存图像的功能。</li> <li><code>test_save_image.cs</code>：C#测试程序。</li></ol> <p>以下是每个文件的内容：</p> <p><strong>CMakeLists.txt:</strong></p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.1</span><span class="token punctuation">)</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>SaveImage<span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>OpenCV REQUIRED<span class="token punctuation">)</span>

<span class="token keyword">include_directories</span><span class="token punctuation">(</span><span class="token punctuation">${</span>OpenCV_INCLUDE_DIRS<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">add_library</span><span class="token punctuation">(</span>SaveImage <span class="token namespace">SHARED</span> save_image.cpp<span class="token punctuation">)</span>

<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>SaveImage <span class="token punctuation">${</span>OpenCV_LIBS<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>save_image.h:</strong></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SAVE_IMAGE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAVE_IMAGE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXPORT</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXPORT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
    EXPORT <span class="token keyword">bool</span> <span class="token function">SaveMono12PackedToImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>save_image.cpp:</strong></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;save_image.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>

<span class="token keyword">bool</span> <span class="token function">SaveMono12PackedToImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">rawImage</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_16UC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Convert Mono12Packed buffer to 16-bit image</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Save image</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> compression_params<span class="token punctuation">;</span>
    compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>IMWRITE_PNG_COMPRESSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compression_params<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> rawImage<span class="token punctuation">,</span> compression_params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Exception<span class="token operator">&amp;</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error saving image: %s\n&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>注意，在<code>save_image.cpp</code>中，你需要实现Mono12Packed到16位图像的转换。这取决于你的Mono12Packed格式。</p> <p><strong>test_save_image.cs:</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TestSaveImage</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;SaveImage.dll&quot;</span><span class="token punctuation">,</span> CallingConvention <span class="token operator">=</span> CallingConvention<span class="token punctuation">.</span>Cdecl<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">SaveMono12PackedToImage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Mono12Packed buffer</span>
        <span class="token class-name"><span class="token keyword">int</span></span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> height <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> filename <span class="token operator">=</span> <span class="token string">&quot;output.png&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SaveMono12PackedToImage</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Image saved successfully.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save image.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>现在，你可以使用CMake生成项目，编译动态库，并使用C#程序测试它。注意，你可能需要将动态库（例如：<code>SaveImage.dll</code>）复制到C#程序的输出目录。</p></li></ul> <p>用C++ 把Mono12Packed的buffer 保存为16位的bmp,tiff,png,raw,jpeg 文件，封装为动态库dll，并使用C#调用存图接口</p> <p><img src="https://ai.6ix.com/static/media/chat-logo.d7335eecda5672f13141.png" alt="img"></p> <ul><li><p><img src="https://ai.6ix.com/static/media/file-text.94e1cfcfde8250c306796f12b3ee9892.svg" alt="text icon"><img src="https://ai.6ix.com/static/media/pdf.29bc25f78710833d379d8954187c2240.svg" alt="pdf icon"><img src="https://ai.6ix.com/static/media/copy.9a6cc88001aee1f088ba2c5fa2998353.svg" alt="copy icon"></p> <p>为了实现这个需求，我们需要完成以下步骤：</p> <ol><li>使用C++创建一个动态库（DLL），该库将负责将Mono12Packed格式的数据转换为16位的图像并保存为不同的文件格式。</li> <li>使用C#编写一个程序，调用上述C++ DLL中的函数。</li></ol> <p>首先，我们来创建一个C++ DLL：</p> <ol><li>使用Visual Studio创建一个新的C++ DLL项目，例如命名为<code>Mono12PackedConverter</code>。</li> <li>在项目中添加一个新的C++源文件，例如命名为<code>Mono12PackedConverter.cpp</code>。</li> <li>在<code>Mono12PackedConverter.cpp</code>中，添加以下代码：</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">image</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_16UC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Convert Mono12Packed to 16-bit image</span>
    <span class="token comment">// ...</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">file_format</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_format <span class="token operator">==</span> <span class="token string">&quot;bmp&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">{</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_BMP_COLOR16 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file_format <span class="token operator">==</span> <span class="token string">&quot;tiff&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">{</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF_COMPRESSION<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_TIFF_LZW <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file_format <span class="token operator">==</span> <span class="token string">&quot;png&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">{</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_PNG_COMPRESSION<span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file_format <span class="token operator">==</span> <span class="token string">&quot;jpeg&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">{</span> cv<span class="token double-colon punctuation">::</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">,</span> <span class="token number">95</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file_format <span class="token operator">==</span> <span class="token string">&quot;raw&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">outfile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outfile<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outfile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>注意：在这个示例中，我们使用了OpenCV库来处理图像。确保在项目中安装并链接OpenCV库。</p> <p>现在，我们使用C#编写一个程序来调用这个C++ DLL：</p> <ol><li>使用Visual Studio创建一个新的C#控制台应用程序项目，例如命名为<code>Mono12PackedConverterTest</code>。</li> <li>在项目中，添加一个新的C#类，例如命名为<code>Mono12PackedConverterWrapper.cs</code>。</li> <li>在<code>Mono12PackedConverterWrapper.cs</code>中，添加以下代码：</li></ol> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mono12PackedConverterWrapper</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Mono12PackedConverter.dll&quot;</span><span class="token punctuation">,</span> CallingConvention <span class="token operator">=</span> CallingConvention<span class="token punctuation">.</span>Cdecl<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">SaveImage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> width<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> height<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> filename<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>在<code>Program.cs</code>中，添加以下代码来测试DLL：</li></ol> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Mono12PackedConverterTest</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Create a sample buffer with Mono12Packed data</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// width * height * 1.5</span>

            <span class="token comment">// Call the C++ DLL to save the image</span>
            <span class="token class-name"><span class="token keyword">int</span></span> result <span class="token operator">=</span> Mono12PackedConverterWrapper<span class="token punctuation">.</span><span class="token function">SaveImage</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;output.bmp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bmp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Image saved successfully.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save image.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>现在，当你运行C#程序时，它将调用C++ DLL中的<code>SaveImage</code>函数，并将Mono12Packed格式的数据保存为指定的图像格式。请注意，这个示例中的<code>buffer</code>只是一个空的示例数据，您需要将其替换为实际的Mono12Packed数据。</p></li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.4da30dd0.js" defer></script><script src="/assets/js/4.a57a78a9.js" defer></script>
  </body>
</html>
